<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nearest Hospital Finder (NS)</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main App Container -->
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg relative">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">
            Nearest Hospital Finder
        </h1>
        <p class="text-center text-gray-600 mb-8">
            Enter your address in Nova Scotia to find the nearest hospital.
        </p>

        <!-- Input Form -->
        <div class="space-y-4">
            <input type="text" id="addressInput" placeholder="e.g., 123 Main Street, Halifax, NS"
                   class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-500 transition-all">
            
            <!-- Autocomplete Suggestions Container -->
            <div id="suggestionsContainer" class="absolute z-10 w-full bg-white border border-gray-300 rounded-xl mt-1 shadow-lg max-h-60 overflow-y-auto hidden">
                <!-- Suggestions will be populated here -->
            </div>

            <button id="findButton"
                    class="w-full bg-gray-700 text-white font-semibold py-4 rounded-xl shadow-lg hover:bg-gray-800 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                Find Nearest Hospital
            </button>
        </div>

        <!-- Result Display Area -->
        <div id="resultContainer" class="mt-8">
            <!-- Loading and results will be displayed here -->
        </div>

        <!-- Message Box for Alerts (replaces `alert()`) -->
        <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-xl shadow-xl w-80 text-center">
                <p id="messageText" class="text-lg text-gray-800 mb-4"></p>
                <button id="closeMessage" class="bg-gray-700 text-white py-2 px-6 rounded-xl hover:bg-gray-800">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Use an IIFE (Immediately Invoked Function Expression) to avoid global scope pollution
        (async function() {
            // Hardcoded list of Nova Scotia hospitals with their coordinates
            // This data was sourced from the Nova Scotia Open Data portal.
            const hospitals = [
                { name: "Cape Breton Regional Hospital", address: "1482 George Street, Sydney", lat: 46.1130158306037, lng: -60.174133616836095 },
                { name: "Northside General Hospital", address: "520 Purves Street, North Sydney", lat: 46.21820836429978, lng: -60.23555151227749 },
                { name: "Victoria County Memorial Hospital", address: "30 Old Margaree Road, Baddeck", lat: 46.100263898319795, lng: -60.75602895190468 },
                { name: "Inverness Consolidated Memorial Hospital", address: "39 James Street, Inverness", lat: 46.22696781337693, lng: -61.30484314307468 },
                { name: "Aberdeen Hospital", address: "835 East River Road, New Glasgow", lat: 45.5729758405446, lng: -62.64326836972356 },
                { name: "New Waterford Consolidated Hospital", address: "716 King Street, New Waterford", lat: 46.239863345496474, lng: -60.085793288911454 },
                { name: "Strait - Richmond Hospital", address: "138 Hospital Road, Evanston", lat: 45.61708351662631, lng: -61.22292639766177 },
                { name: "St. Martha's Regional Hospital", address: "25 Bay Street, Antigonish", lat: 45.62817596985708, lng: -61.98219333746746 },
                { name: "Eastern Memorial Hospital", address: "1746 Union Street, Canso", lat: 45.33262820682038, lng: -60.98400464643825 },
                { name: "Sutherland Harris Memorial Hospital", address: "222 Haliburton Road, Pictou", lat: 45.67651539921786, lng: -62.72703251932275 },
                { name: "Buchanan Memorial Community Health Centre", address: "32610 Cabot Trail, Neil's Harbour", lat: 46.81056959301277, lng: -60.33432729802968 },
                { name: "St. Mary's Memorial Hospital", address: "91 Hospital Road, Sherbrooke", lat: 45.14693579634446, lng: -61.981780294520306 },
                { name: "IWK Health Centre", address: "5850 University Avenue, Halifax", lat: 44.6468, lng: -63.5855 },
                { name: "Halifax Infirmary (QEII)", address: "1796 Summer Street, Halifax", lat: 44.6475, lng: -63.5878 },
                { name: "Dartmouth General Hospital", address: "325 Pleasant Street, Dartmouth", lat: 44.6859, lng: -63.5358 },
                { name: "Hants Community Hospital", address: "89 Payzant Drive, Windsor", lat: 45.0069, lng: -64.1292 },
                { name: "South Shore Regional Hospital", address: "90 Glen Allan Drive, Bridgewater", lat: 44.3855, lng: -64.5369 },
                { name: "Valley Regional Hospital", address: "150 Exhibition Street, Kentville", lat: 45.0772, lng: -64.4984 },
                { name: "Annapolis Community Health Centre", address: "821 St George St, Annapolis Royal", lat: 44.7456, lng: -65.5135 },
                { name: "Queens General Hospital", address: "131 School Street, Liverpool", lat: 44.0373, lng: -64.7075 }
            ];

            // Get references to DOM elements
            const addressInput = document.getElementById('addressInput');
            const findButton = document.getElementById('findButton');
            const resultContainer = document.getElementById('resultContainer');
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const closeMessageButton = document.getElementById('closeMessage');
            const suggestionsContainer = document.getElementById('suggestionsContainer');

            // Replace with your actual API key from geocode.maps.co
            // You can get a free key from their website.
            const API_KEY = "688fc7ef3880f671370341oxl53f970";

            // Haversine formula to calculate distance between two points on a sphere
            // The Earth's radius is approximately 6371 kilometers.
            function haversineDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                          Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                const d = R * c; // Distance in km
                return d;
            }

            // Function to display a custom alert message
            function showMessage(message) {
                messageText.textContent = message;
                messageBox.classList.remove('hidden');
            }

            // Close the message box
            closeMessageButton.addEventListener('click', () => {
                messageBox.classList.add('hidden');
            });

            // Debounce function to limit how often a function is called
            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }

            // Function to fetch and display autocomplete suggestions
            async function fetchSuggestions() {
                const query = addressInput.value.trim();

                if (query.length < 3) {
                    suggestionsContainer.innerHTML = '';
                    suggestionsContainer.classList.add('hidden');
                    return;
                }

                // Show a loading indicator in the suggestions container
                suggestionsContainer.innerHTML = `<div class="p-3 text-gray-500">Loading...</div>`;
                suggestionsContainer.classList.remove('hidden');

                try {
                    const geocodeUrl = `https://geocode.maps.co/search?q=${encodeURIComponent(query)}&country=ca&state=Nova+Scotia&api_key=${API_KEY}`;
                    const response = await fetch(geocodeUrl);
                    
                    // Check for a non-ok response from the API
                    if (!response.ok) {
                        console.error("Geocoding API Error:", response.status, await response.text());
                        suggestionsContainer.innerHTML = `<div class="p-3 text-gray-700">Error fetching suggestions. Please check API key.</div>`;
                        return;
                    }

                    const data = await response.json();

                    suggestionsContainer.innerHTML = ''; // Clear previous suggestions

                    if (data.length > 0) {
                        data.forEach(item => {
                            const suggestionItem = document.createElement('div');
                            suggestionItem.textContent = item.display_name;
                            suggestionItem.classList.add('p-3', 'cursor-pointer', 'hover:bg-gray-200');
                            suggestionItem.addEventListener('click', () => {
                                addressInput.value = item.display_name;
                                suggestionsContainer.classList.add('hidden');
                            });
                            suggestionsContainer.appendChild(suggestionItem);
                        });
                    } else {
                        suggestionsContainer.innerHTML = `<div class="p-3 text-gray-500">No suggestions found.</div>`;
                    }
                } catch (error) {
                    console.error("Error fetching suggestions:", error);
                    suggestionsContainer.innerHTML = `<div class="p-3 text-gray-700">An error occurred.</div>`;
                }
            }

            const debouncedFetchSuggestions = debounce(fetchSuggestions, 300);

            // Event listener for the address input to trigger autocomplete
            addressInput.addEventListener('input', debouncedFetchSuggestions);

            // Hide suggestions when clicking outside the container
            document.addEventListener('click', (event) => {
                if (!suggestionsContainer.contains(event.target) && event.target !== addressInput) {
                    suggestionsContainer.classList.add('hidden');
                }
            });

            // Main function to handle finding the nearest hospital
            async function findNearestHospital() {
                const userAddress = addressInput.value.trim();
                suggestionsContainer.classList.add('hidden'); // Hide suggestions on search

                // Basic validation
                if (!userAddress) {
                    showMessage("Please enter a valid address.");
                    return;
                }

                // Check for API key
                if (API_KEY === "YOUR_GEOCODING_API_KEY") {
                    showMessage("Please get a free API key from geocode.maps.co and replace the placeholder in the code.");
                    return;
                }

                // Show a loading indicator
                resultContainer.innerHTML = `
                    <div class="text-center text-gray-500">
                        <svg class="animate-spin h-8 w-8 text-gray-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2">Finding the nearest hospital...</p>
                    </div>
                `;

                try {
                    // Geocode the user's address to get coordinates, now with location filtering
                    const geocodeUrl = `https://geocode.maps.co/search?q=${encodeURIComponent(userAddress)}&country=ca&state=Nova+Scotia&api_key=${API_KEY}`;
                    const response = await fetch(geocodeUrl);

                    // Check if the API response was successful
                    if (!response.ok) {
                        const errorData = await response.text();
                        console.error("Geocoding API Error:", response.status, errorData);
                        showMessage(`Error from geocoding service: ${response.status} - ${response.statusText}. Please check the API key or try again later.`);
                        resultContainer.innerHTML = '';
                        return;
                    }
                    
                    const data = await response.json();

                    if (data.length === 0) {
                        showMessage("Address not found in Nova Scotia. Please try again with a more specific address.");
                        resultContainer.innerHTML = '';
                        return;
                    }

                    const userLat = parseFloat(data[0].lat);
                    const userLng = parseFloat(data[0].lon);

                    let nearestHospital = null;
                    let minDistance = Infinity;

                    // Iterate through the hospitals to find the nearest one
                    for (const hospital of hospitals) {
                        const distance = haversineDistance(userLat, userLng, hospital.lat, hospital.lng);
                        if (distance < minDistance) {
                            minDistance = distance;
                            nearestHospital = hospital;
                        }
                    }

                    // Display the results
                    if (nearestHospital) {
                        const distanceKm = minDistance.toFixed(2);
                        const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${encodeURIComponent(nearestHospital.address)}`;
                        
                        resultContainer.innerHTML = `
                            <div class="bg-gray-50 p-6 rounded-xl shadow-inner border-l-4 border-gray-600">
                                <p class="text-base text-gray-700 mb-2">The nearest hospital to the location above is the</p>
                                <p class="text-lg text-gray-900 font-semibold mb-1">${nearestHospital.name}</p>
                                <p class="text-base text-gray-700 mb-4">${nearestHospital.address}</p>
                                <p class="text-gray-700 mb-4">Distance: <span class="font-bold">${distanceKm} km</span></p>
                                <a href="${googleMapsUrl}" target="_blank"
                                   class="inline-block bg-gray-700 text-white font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-gray-800 transition-all duration-300">
                                    Get Directions on Google Maps
                                </a>
                            </div>
                        `;
                    } else {
                        showMessage("Could not find a hospital. Please try again.");
                    }

                } catch (error) {
                    console.error("Error finding nearest hospital:", error);
                    showMessage("An error occurred. Please check your address and try again.");
                    resultContainer.innerHTML = '';
                }
            }

            // Event listener for the button click
            findButton.addEventListener('click', findNearestHospital);

            // Allow hitting Enter key in the input field
            addressInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    findButton.click();
                }
            });
        })();
    </script>
</body>
</html>
